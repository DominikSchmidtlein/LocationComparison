<!DOCTYPE html>
<html>
<head>
  <title>Simple Map</title>
  <meta name="viewport" content="initial-scale=1.0">
  <meta charset="utf-8">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #map {
      height: 100%;
    }
    #table-body tr:hover {
      background-color: yellow;
    }
  </style>
</head>
<body>
  <div>
    <table border="1">
      <thead>
        <tr>
          <th>Source</th>
          <th>Destination</th>
          <th>Transportation</th>
          <th>Distance</th>
          <th>Duration</th>
        </tr>
      </thead>
      <tbody id="table-body">
      </tbody>
    </table>
    <input type="button" value="Add Row" onclick="return addRow()">
    <input type="button" value="Submit" onclick="return setupMap()">
  </div>
  <div id="map"></div>
  <template id="row-template">
    <tr onclick="return onRowClick()">
      <td><input type="text" name="source-address"></input></td>
      <td><input type="text" name="destination-address"></input></td>
      <td>
        <select name="travel-mode">
          <option value="DRIVING">Car</option>
          <option value="TRANSIT">Transit</option>
          <option value="BICYCLING">Bike</option>
          <option value="WALKING">Walk</option>
        </select>
      </td>
      <td name="distance"></td>
      <td name="duration"></td>
    </tr>
  </template>
  <script>
    var map;
    var geocoder;
    var distanceMatrix;
    var directionsService;
    var directionsDisplay;
    var markers;

    function initMap() {
      geocoder = new google.maps.Geocoder();
      distanceMatrix = new google.maps.DistanceMatrixService();
      directionsService = new google.maps.DirectionsService;
      directionsRenderer = new google.maps.DirectionsRenderer;
    }

    function onRowClick() {
      if(map) {
        var source = rows[i].cells[0].children[0].value;
        var destination = rows[i].cells[1].children[0].value;
        var mode = rows[i].cells[2].children[0].value;

        displayRoute(source, destination, mode);
      }
    }



    function centerByAddress(address) {
      geocoder.geocode({'address':address}, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
          map.setCenter(results[0].geometry.location);
        } else {
          alert("Unsuccessful");
        }
      });
    }
    
    function setupMap() {
      var rows = document.getElementById('table-body').children;
      markers = [];

      map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 0, lng: 0},
        zoom: 8
      });

      directionsRenderer.setMap(map);

      for(var i = 0; i < rows.length; i++) {
        // get entries from table
        var source = rows[i].cells[0].children[0].value;
        var destination = rows[i].cells[1].children[0].value;
        var travelMode = rows[i].cells[2].children[0].value;

        configureRoute(i, source, destination, travelMode, fitBounds);
      }
    }

    function configureRoute(index, src, dest, mode, callback) {
      distanceMatrix.getDistanceMatrix({
        origins: [src],
        destinations: [dest],
        travelMode: mode
      }, function(response, status) {
        if (status == google.maps.DistanceMatrixStatus.OK) {

          var source = response.originAddresses[0];
          var destination = response.destinationAddresses[0];
          var distance = response.rows[0].elements[0].distance.text;
          var duration = response.rows[0].elements[0].duration.text;

          // update table
          populateRow(index, source, destination, mode, distance, duration);

          // add markers
          addMarker(source, locationFree, callback);
          addMarker(destination, locationFree, callback);
        }
      });
    }

    function locationFree(location) {
      for (var i = 0; i < markers.length; i ++) {
        if(markers[i].getPosition() == location) {
          return false;
        }
      }
      return true;
    }

    // display directions on map
    function displayRoute(src, dest, mode) {
      directionsService.route({
        origin: src,
        destination: dest,
        travelMode: mode
      }, function(response, status) {
        if(status == google.maps.DirectionsStatus.OK) {
          directionsRenderer.setDirections(response);
        }
      });
    }

    function geocode(address, callback) {
      geocoder.geocode({'address': address}, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
          callback(results[0].geometry.location);
        }
      });
    }

    function addMarker(address, condition, callback) {
      geocode(address, function(location) {
        var marker = new google.maps.Marker({
        position: location
        });
        if(condition(location)) {
          marker.setMap(map);
          markers.push(marker);
          if (callback) callback();
        }
      });
    }

    function fitBounds() {
      var bounds = new google.maps.LatLngBounds();
      for (var i = 0; i <  markers.length; i++) {
        bounds.extend(markers[i].getPosition());
      }
      map.fitBounds(bounds);
    }

    var rowTemplate = document.getElementById("row-template");
    function addRow() {
      var tableBody = document.getElementById("table-body");
      var clone = document.importNode(rowTemplate.cloneNode(true).content, true);
      tableBody.appendChild(clone);
    }

    function populateRow(index, src, dest, trans, distance, duration) {
      var tableRow = document.getElementById("table-body").children[index];
      tableRow.children[0].children[0].value = src;
      tableRow.children[1].children[0].value = dest;
      tableRow.children[2].children[0].value = trans;
      tableRow.children[3].innerHTML = distance;
      tableRow.children[4].innerHTML = duration;
    }

    function getRowData(index) {
      var source = rows[index].cells[0].children[0].value;
      var destination = rows[index].cells[1].children[0].value;
      var travelMode = rows[index].cells[2].children[0].value;
      return {
        source: source,
        destination: destination,
        travelMode: travelMode
      };
    }
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBsLNoI0qIGImUA31Fbz9YZeAZXMMmHktg&callback=initMap"async defer></script>
</body>
</html>

